# documents_bot

Коротко
- Система для автоматичної перевірки та прийому документів із використанням AI (GPT-4 Vision / Responses API) і завантаженням у Google Drive.
- Мета: автоматизувати первинну валідацію завантажених користувачами документів (паспорт, ІПН, виписки, чеки, договори тощо) й позначати для ручної перевірки, якщо модель не впевнена.

Основні можливості
- Двокрокова перевірка документів: якість зображення + тип документа (набір промптів у prompts.py).
- Підтримка зображень (jpg, png тощо) через GPT-4 Vision і PDF через Responses API.
- Генерація/використання Google OAuth токена для завантаження файлів у Google Drive (скрипт generate_oauth_token.py).
- Готовність до використання як локально, так і на хостингу (наприклад, Render.com).

Структура репозиторію (ключові файли)
- telegram_bot.py — основний бот (інтеграція з Telegram, логіка обробки, завантаження файлів).
- ai_document_validator.py — модуль AI-валидації (взаємодія з GPT-4 Vision і Responses API, парсинг відповідей, ValidationResult).
- google_sheets_manager.py — модуль синхронізації даних з Google Sheets (автоматичне оновлення кожні 4 години).
- prompts.py — набір промптів і кодів помилок для стандартизованої валідації.
- generate_oauth_token.py — утиліта для локальної генерації token.json для Google Drive.
- requirements.txt — залежності.
- runtime.txt — версія Python для платформ типу Render.
-

Підтримка й експлуатація — на що звернути увагу
1. Баланс OpenAI і ліміти:
   - Слідкуйте за балансом/платіжною інформацією в кабінеті OpenAI. Коли баланс закінчиться — AI-валідація припинить працювати.
   - Рекомендую налаштувати ліміти та алерти в акаунті OpenAI і моніторити споживання токенів.
2. Оновлення SDK OpenAI:
   - У коді використовуються і legacy openai (chat completions для зображень), і новий клієнт Responses API. Слідкуйте за змінами SDK і моделями — при апгрейдах SDK може знадобитися правка коду (створення клієнтів, методи завантаження файлів).
3. Секрети і безпека:
   - НІКОЛИ: не комітьте client_secret.json, token.json, OPENAI keys або інші секрети в репозиторій.
   - Зберігайте їх у змінних оточення Render / у захищеному сховищі.
   - Регулярно ротувати ключі.
4. Google OAuth token:
   - token.json потрібно генерувати локально (generate_oauth_token.py). Зазвичай refresh token діє довго, але при зміні credentials/доступів потрібно регенерувати.
5. Логування і обробка помилок:
   - Відстежуйте логи Telegram і ai_document_validator (особливо помилки парсингу JSON від моделі).
   - Додайте алерти на часті помилки (наприклад: помилки кодування зображень, помилки API OpenAI, перевищення лімітів).
6. Кеш завантажень PDF:
   - ai_document_validator зберігає кеш завантажених PDF (по шляху + розмір). Якщо ви оновлюєте логіку завантаження/файли, потрібно очищати/переглянути кеш.
7. Точність валідації і промпти:
   - Промпти знаходяться в prompts.py. При необхідності адаптувати під нові вимоги бізнесу — змінюйте тексти і тестуйте на прикладах.
   - Важливо: політика "будь лояльним" закладена в промптах — врахуйте це при підготовці правил ручної модерації.
8. Тестування:
   - Підготуйте набір тестових зображень/PDF для регресійного тестування при оновленнях промптів/моделей.
9. Приватність даних:
   - Переконайтеся, що завантаження персональних даних відповідає політиці конфіденційності (GDPR/локальне законодавство).
   - Мінімізуйте логування персональних даних.

## Google Sheets інтеграція

Система автоматично синхронізує дані з PostgreSQL в Google Sheets для зручного перегляду статусів клієнтів та документів.

### Налаштування змінних оточення:

**Обов'язкові:**
```bash
GOOGLE_SPREADSHEET_ID=<ID вашої Google таблиці>
```
ID таблиці можна взяти з URL:
`https://docs.google.com/spreadsheets/d/[ЦЕ_ID_ТАБЛИЦІ]/edit`

**Опціональні:**
```bash
GOOGLE_SHEET_NAME=Табличка  # Назва листа в таблиці (за замовчуванням "Табличка")
```

### Як працює синхронізація:

1. **Перший запуск:** Якщо таблиця порожня, автоматично виконується `initial_sync` - повна вивантажка всіх клієнтів з БД
2. **Регулярна синхронізація:** Кожні 4 години виконується `incremental_sync`:
   - Додаються НОВІ клієнти (яких немає в таблиці)
   - Оновлюються ТІЛЬКИ чекбокси документів (✅/❌) та статус
   - НЕ перезаписуються кольори, коментарі та інші ручні зміни адмінів
3. **Батчеві оновлення:** Всі операції виконуються пакетами по 100 рядків для уникнення перевищення лімітів API

### Структура таблиці:

| Колонка | Опис |
|---------|------|
| № | Порядковий номер |
| ПІБ | Повне ім'я клієнта |
| ТЕЛЕФОН | Номер телефону |
| Telegram | Telegram ID |
| Паспорт ІПН | ✅/❌ |
| ЕЦП | ✅/❌ |
| Пароль ЕЦП | ✅/❌ |
| Довідка реєстр | ✅/❌ |
| Трудова книжка | ✅/❌ |
| Кредитні договори | ✅/❌ |
| Виписки банк | ✅/❌ |
| Витрати | ✅/❌ |
| Історія | ✅/❌ |
| Доходи сім'ї | ✅/❌ |
| Заборгованості | ✅/❌ |
| Виконавчі | ✅/❌ |
| Додаткові | ✅/❌ |
| Статус | "В процесі" / "Завершено" |
| client_id | (прихована) ID з БД для синхронізації |
| last_sync | (прихована) Час останнього оновлення |

### Налаштування доступу:

1. Використовується існуючий `GOOGLE_OAUTH_TOKEN` для автентифікації
2. Переконайтеся, що Google Sheets API увімкнений в Google Cloud Console
3. Надайте доступ до таблиці акаунту, який використовується в OAuth токені

### Обробка помилок:

- Всі операції з Google Sheets обгорнуті в `try-except`
- При помилці синхронізації логується помилка, але PostgreSQL продовжує працювати
- PostgreSQL залишається основним джерелом даних (source of truth)
- Google Sheets - це відображення для зручності перегляду
